"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const Channel_1 = __importDefault(require("./Channel"));
/**
 * Multicasts pushed values to a variable number of async iterable iterators
 * as receivers or subscribers.
 *
 * Does not buffer pushed values; if no receivers are registered, pushed
 * values are silently discarded.
 */
class Multicast {
    constructor(init = () => new Channel_1.default()) {
        this.init = init;
        this.receivers = new Set();
    }
    /**
     * Pushes a value to all registered receivers.
     */
    push(value) {
        this.receivers.forEach(balancer => balancer.push(value));
        return this;
    }
    /**
     * Creates and registers a receiver.
     */
    [Symbol.asyncIterator]() {
        const producer = this.init();
        const { receivers } = this;
        receivers.add(producer);
        if (this.onStart && receivers.size === 1) {
            this.onStart();
        }
        return producer.wrap(() => {
            receivers.delete(producer);
            if (this.onStop && receivers.size === 0) {
                this.onStop();
            }
        });
    }
}
exports.default = Multicast;
//# sourceMappingURL=Multicast.js.map